#!/bin/bash

source ../etc/profile

EXEC_DATE=`date '+%Y%m%d'`
OUTFILE=iostat_${EXEC_DATE}.csv
PID=`ps aux | grep "iostat -mxd" | grep -v grep | awk '{print $2}'`

echo "kill -9 ${PID}"
kill -9 ${PID}

## 出力先CSVを作成
touch ${OUTFILE}
## CSVヘッダをリダイレクト
echo -n "Time,Device,r/s,rMB/s,rrqm/s,%rrqm,r_await,rareq-sz,w/s,wMB/s,wrqm/s,%wrqm,w_await,wareq-sz,d/s,dMB/s,drqm/s,%drqm,d_await,dareq-sz,aqu-sz,%util" > ${OUTFILE}
echo >> ${OUTFILE}

touch tmp_${OUTFILE}

for device in ${DEVICE_LIST}
do
  grep ${device} tmp_iostat_${EXEC_DATE}.log | sed -e 's/\s\+/,/2g' >> tmp_${OUTFILE}
done

cat tmp_${OUTFILE} | sort -t ',' -k 1,2 >> ${OUTFILE}

## デバイス毎のCSVを作成
awk -F, 'NR == 1 {header = $0} NR > 1 {device = $2; filename = "iostat_device_"device".csv"; if (!(device in output_files)) {output_files[device] = filename; print header > filename} print >> output_files[device]}' ${OUTFILE}

rm tmp_iostat_*.log
rm tmp_iostat_*.csv